# ICP 网络配置说明

## 问题背景

ICP 主网在某些地区（如中国大陆）可能需要翻墙才能访问。为了解决这个问题，我们添加了以下功能：

1. **多端点支持**：支持多个 ICP API 端点，自动尝试连接
2. **手动配置**：用户可以通过界面手动选择 API 端点
3. **自动故障转移**：当主端点无法连接时，自动尝试其他端点

## 可用的 ICP API 端点

当前支持以下 ICP 主网 API 端点：

- `https://icp-api.io` (默认)
- `https://ic0.app`
- `https://boundary.ic0.app`

## 使用方法

### 方法 1: 通过界面配置（推荐）

1. 访问应用后，点击导航栏右侧的 🌐 图标
2. 在弹出的网络配置面板中：
   - 查看当前使用的端点
   - 选择其他可用的端点
   - 点击"测试连接"验证端点是否可用
   - 点击"保存并刷新"应用新配置

### 方法 2: 通过浏览器控制台

如果界面无法访问，可以通过浏览器控制台手动设置：

```javascript
// 设置自定义端点
localStorage.setItem('ICP_CUSTOM_API_HOST', 'https://ic0.app');

// 清除自定义端点（恢复默认）
localStorage.removeItem('ICP_CUSTOM_API_HOST');

// 设置后需要刷新页面
location.reload();
```

## 自动故障转移

当应用尝试连接 ICP 网络时，会自动按顺序尝试所有可用的端点：

1. 首先尝试用户自定义的端点（如果已设置）
2. 然后尝试默认端点 `https://icp-api.io`
3. 如果失败，依次尝试其他备用端点

如果某个端点连接成功，会自动保存为新的首选端点。

## 错误提示

如果所有端点都无法连接，应用会显示友好的错误提示，包括：

- 已尝试的端点列表
- 最后的错误信息
- 针对中国大陆用户的 VPN 提示

## 技术实现

### 配置文件

网络配置在 `src/icp_chat_frontend/src/config.ts` 中管理：

- `config.availableHosts`: 获取所有可用的端点列表
- `config.setCustomHost(host)`: 设置自定义端点
- `config.clearCustomHost()`: 清除自定义端点

### Actor 创建

在 `src/icp_chat_frontend/src/services/icpAgent.ts` 中实现了自动故障转移：

- `createActorWithFallback()`: 尝试多个端点创建 Actor
- 如果某个端点失败，自动尝试下一个
- 所有端点都失败时，抛出包含详细信息的错误

## 常见问题

### Q: 为什么需要配置网络？

A: ICP 主网的某些 API 端点可能在某些地区无法直接访问，需要：
- 使用 VPN
- 或切换到其他可用的端点

### Q: 如何知道哪个端点可用？

A: 在网络配置面板中点击"测试连接"按钮，可以验证端点是否可用。

### Q: 配置会保存吗？

A: 是的，自定义端点会保存在浏览器的 localStorage 中，下次访问时会自动使用。

### Q: 本地开发需要配置吗？

A: 不需要。本地开发时使用 `localhost:4943`，不需要额外配置。

## 注意事项

1. **VPN 使用**：如果在中国大陆，建议使用 VPN 访问 ICP 主网
2. **端点选择**：不同端点可能有不同的访问速度，建议测试后选择最快的
3. **配置持久化**：端点配置保存在浏览器本地，清除浏览器数据会丢失配置

