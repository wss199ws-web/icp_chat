# 部署安全性检查

## 网络检测机制分析

### ✅ 运行时检测（安全）

前端应用使用**运行时检测**来确定网络类型，优先级如下：

1. **hostname 检测（最高优先级）**
   - 如果访问 `*.ic0.app` 或 `*.icp0.io` → **强制识别为主网**
   - 如果访问 `localhost` 或 `127.0.0.1` → **强制识别为本地网络**
   - **这是最安全的机制**，即使构建时配置错误，运行时也会根据实际访问域名自动纠正

2. **构建时环境变量（备用）**
   - 只有在 hostname 检测无法确定时才会使用
   - 主要用于开发服务器场景

### ⚠️ 构建时配置（需要注意）

#### 当前逻辑：
1. 优先读取本地 canister IDs（`.dfx/local/canister_ids.json`）
2. 如果找不到，读取 `.env` 文件
3. 如果 `.env` 中是主网配置，但找到本地 canister ID，会切换到本地模式

#### 潜在风险：
- **场景1**：本地开发时，`.env` 文件是主网配置
  - ✅ **安全**：vite.config.ts 会优先使用本地 canister ID
  - ✅ **安全**：即使构建时用了主网配置，运行时检测到 localhost 会强制使用本地网络

- **场景2**：主网部署时，`.env` 文件是主网配置
  - ✅ **安全**：构建时会使用主网配置
  - ✅ **安全**：运行时检测到 `.ic0.app` 域名会强制使用主网

- **场景3**：误操作 - 在主网环境构建了本地配置
  - ⚠️ **风险较低**：运行时检测会纠正（如果访问 `.ic0.app` 域名）
  - ⚠️ **风险**：如果构建时用了错误的 canister ID，可能导致连接失败

## 保护机制

### ✅ 已实现的保护：

1. **运行时 hostname 检测（最强保护）**
   ```typescript
   // 优先级 1: 通过 hostname 检测
   if (hostname.includes('.ic0.app') || hostname.includes('.icp0.io')) {
     return 'ic'; // 强制主网
   }
   if (hostname === 'localhost' || hostname === '127.0.0.1') {
     return 'local'; // 强制本地
   }
   ```

2. **构建时优先使用本地配置**
   ```typescript
   // 优先读取本地 canister IDs
   const localCanisterIdsPath = resolve(__dirname, '../../.dfx/local/canister_ids.json')
   ```

3. **默认安全策略**
   - 如果无法确定网络类型，默认使用本地网络（更安全）

### ⚠️ 建议的改进：

1. **添加构建时警告**
   - 如果检测到 `.env` 是主网配置，但正在本地构建，应该警告用户

2. **添加部署前检查脚本**
   - 检查 `.env` 文件中的网络配置
   - 检查构建产物中的配置

## 部署检查清单

### 本地开发部署：
- [ ] `.env` 文件中的 `DFX_NETWORK` 应该是 `local` 或不存在
- [ ] 本地 canister ID 存在（`.dfx/local/canister_ids.json`）
- [ ] 访问 `localhost:8080` 时，控制台显示 `network: 'local'`

### 主网部署：
- [ ] `.env` 文件中的 `DFX_NETWORK=ic`
- [ ] `.env` 文件中的 `CANISTER_ID_ICP_CHAT_BACKEND` 是主网 ID
- [ ] 构建时日志显示使用主网配置
- [ ] 部署后访问 `*.ic0.app` 域名，控制台显示 `network: 'ic'`

## 结论

### ✅ 当前配置是安全的：

1. **运行时检测机制**确保：
   - 访问 `.ic0.app` 域名 → 强制使用主网
   - 访问 `localhost` → 强制使用本地网络
   - **即使构建时配置错误，运行时也会自动纠正**

2. **构建时配置**：
   - 优先使用本地配置（开发友好）
   - 主网部署时会使用主网配置（正确）

3. **默认策略**：
   - 无法确定时默认本地网络（更安全）

### ⚠️ 注意事项：

1. **部署主网前**：
   - 确保 `.env` 文件是主网配置
   - 确保构建时使用了主网配置
   - 部署后验证访问 `.ic0.app` 域名时网络检测正确

2. **本地开发时**：
   - 如果 `.env` 是主网配置，vite.config.ts 会自动使用本地配置
   - 运行时检测会确保使用本地网络

### 🎯 总结：

**当前的配置机制是安全的**，主要依赖运行时检测，即使构建时配置错误，也不会影响线上环境。但建议在部署前进行验证。

